<!DOCTYPE html>
<html>
<head>
    <title>Sistema de Tubulações com Bombas</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    
    <style>
        #map { height: 100vh; }
        .menu-contextual {
            position: absolute;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Menus contextuais -->
    <div id="popup-menu-tubulacao" class="menu-contextual">
        <h3>Propriedades da Tubulação</h3>
        <input type="text" id="tubulacao-name" placeholder="Nome">
        <button onclick="salvarPropriedadesTubulacao()">Salvar</button>
    </div>

    <div id="popup-menu-bomba" class="menu-contextual">
        <h3>Propriedades da Bomba</h3>
        <input type="text" id="bomba-name" placeholder="Nome">
        <input type="number" id="bomba-capacidade" placeholder="Capacidade (L/s)">
        <input type="number" id="bomba-potencia" placeholder="Potência (CV)">
        <button onclick="salvarPropriedadesBomba()">Salvar</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/terraformer@1.0.9/terraformer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/terraformer-rtree@1.0.0/terraformer-rtree.min.js"></script>

<script>
// Configuração inicial do mapa
const map = L.map('map').setView([-25.9667, 32.5833], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// Grupos de elementos
const tubulacoes = L.featureGroup().addTo(map);
const bombas = L.featureGroup().addTo(map);
const drawnItems = L.featureGroup().addTo(map);

// Ícones personalizados
const iconeBomba = L.AwesomeMarkers.icon({
    icon: 'tint',
    prefix: 'fa',
    markerColor: 'red',
    iconColor: 'white',
    spin: false
});

const estiloTubulacao = {
    color: '#0066cc',
    weight: 4,
    opacity: 0.8
};

// Controle de desenho
const drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { 
        polyline: { 
            shapeOptions: estiloTubulacao,
            showLength: true
        },
        marker: { icon: iconeBomba },
        polygon: false,
        rectangle: false,
        circle: false
    }
});
map.addControl(drawControl);

// Eventos de desenho
map.on(L.Draw.Event.CREATED, function (e) {
    const layer = e.layer;
    
    if (e.layerType === 'polyline') {
        layer.customProperties = {
            tipo: 'tubulacao',
            name: 'Nova Tubulação',
            material: 'PVC',
            diametro: null,
            pressao_trabalho: null
        };
        tubulacoes.addLayer(layer);
    }
    else if (e.layerType === 'marker') {
        layer.customProperties = {
            tipo: 'bomba',
            name: 'Nova Bomba',
            capacidade: null,
            potencia: null,
            eficiencia: null
        };
        bombas.addLayer(layer);
    }

    layer.on('click', function(e) {
        if (layer.customProperties.tipo === 'tubulacao') {
            mostrarMenuTubulacao(e, layer);
        } else {
            mostrarMenuBomba(e, layer);
        }
    });
    
    updateElevationData(layer);
    drawnItems.addLayer(layer);
});

// Sistema de elevação
async function updateElevationData(layer) {
    if (layer instanceof L.Polyline) {
        const latlngs = layer.getLatLngs();
        let htmlContent = '<strong>Dados da Tubulação:</strong><br>';
        
        for (let i = 0; i < latlngs.length; i++) {
            const { lat, lng } = latlngs[i];
            const response = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`);
            const data = await response.json();
            const elevation = data.results[0].elevation;
            
            htmlContent += `Ponto ${i + 1}: ${elevation.toFixed(2)}m<br>`;
        }
        
        layer.bindPopup(htmlContent);
    }
}

// Menus contextuais
function mostrarMenuTubulacao(event, layer) {
    const menu = document.getElementById('popup-menu-tubulacao');
    document.getElementById('tubulacao-name').value = layer.customProperties.name;
    
    menu.style.display = 'block';
    menu.style.left = `${Math.min(event.originalEvent.clientX, window.innerWidth - menu.offsetWidth - 10)}px`;
    menu.style.top = `${Math.min(event.originalEvent.clientY, window.innerHeight - menu.offsetHeight - 10)}px`;
}

function mostrarMenuBomba(event, layer) {
    const menu = document.getElementById('popup-menu-bomba');
    document.getElementById('bomba-name').value = layer.customProperties.name;
    document.getElementById('bomba-capacidade').value = layer.customProperties.capacidade || '';
    document.getElementById('bomba-potencia').value = layer.customProperties.potencia || '';
    
    menu.style.display = 'block';
    menu.style.left = `${Math.min(event.originalEvent.clientX, window.innerWidth - menu.offsetWidth - 10)}px`;
    menu.style.top = `${Math.min(event.originalEvent.clientY, window.innerHeight - menu.offsetHeight - 10)}px`;
}

function salvarPropriedadesTubulacao() {
    const menu = document.getElementById('popup-menu-tubulacao');
    // Implementar lógica de salvamento
    menu.style.display = 'none';
}

function salvarPropriedadesBomba() {
    const menu = document.getElementById('popup-menu-bomba');
    // Implementar lógica de salvamento
    menu.style.display = 'none';
}
</script>
</body>
</html>
