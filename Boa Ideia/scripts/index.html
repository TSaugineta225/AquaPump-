<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa</title>

<!-- Leaflet e plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<style>
    * { margin:0; padding:0; box-sizing:border-box; }
    #map { height:100vh; width:100vw; }

    /* Popup customizado */
    .menu-popup {
        position: fixed;
        background:#fff;
        border:1px solid #ccc;
        border-radius:10px;
        padding:15px;
        box-shadow:0 4px 12px rgba(0,0,0,0.25);
        z-index:1000;
        min-width:240px;
        display:none;
    }
    .menu-popup h3 { margin-bottom:12px; font-size:16px; font-weight:bold; color:#222; }
    .menu-popup label { display:block; margin:10px 0 4px; font-size:13px; color:#444; }
    .menu-popup input, .menu-popup select { 
        width:100%; padding:6px; border:1px solid #bbb; border-radius:6px; margin-bottom:6px; 
    }
    .menu-actions { display:flex; gap:10px; margin-top:12px; }
    .menu-popup button { flex:1; padding:8px; border:none; border-radius:6px; cursor:pointer; color:white; }
    #apply-accessory { background:#2d89ef; } #apply-accessory:hover { background:#0056b3; }
    #delete-accessory { background:#a29898; } #delete-accessory:hover { background:#a71d2a; }
    .close-btn { position:absolute; top:8px; right:8px; background:none; border:none; font-size:20px; color:#777; cursor:pointer; }
    .close-btn:hover { color:#333; }
</style>
</head>
<body>
<div id="map"></div>

<!-- Popup customizado -->
<div id="popup-menu" class="menu-popup">
    <button class="close-btn">&times;</button>
    <h3>Editar Acess贸rio</h3>

    <label for="acessorio-tipo">Tipo</label>
    <select id="acessorio-tipo">
        <option value="v谩lvula">V谩lvula</option>
        <option value="bomba">Bomba</option>
        <option value="hidrante">Hidrante</option>
        <option value="outro">Outro</option>
    </select>

    <label for="acessorio-cor">Cor</label>
    <input type="color" id="acessorio-cor" value="#ff0000">

    <div class="menu-actions">
        <button id="apply-accessory">Aplicar</button>
        <button id="delete-accessory">Eliminar</button>
    </div>
</div>

<script>
    const map = L.map('map', { center: [-25.9667,32.5833], zoom:6 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'&copy; OpenStreetMap'
    }).addTo(map);
    L.control.scale({metric:true, imperial:false}).addTo(map);

    const drawnItems = new L.FeatureGroup().addTo(map);
    new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: {
            polyline: { shapeOptions:{color:'#0000ff', weight:3} },
            circle:true,
            polygon:false,
            rectangle:false,
            marker:false
        }
    }).addTo(map);

    let layerSelecionada = null;
    const menu = document.getElementById('popup-menu');

    //  lista cumulativa de acess贸rios
    let acessorios = [];

    function mostrarMenuPopup(e){
        menu.style.display='block';
        menu.style.left=`${Math.min(e.clientX, window.innerWidth - menu.offsetWidth -10)}px`;
        menu.style.top=`${Math.min(e.clientY, window.innerHeight - menu.offsetHeight -10)}px`;
    }
    function fecharMenu(){ menu.style.display='none'; }

    map.on(L.Draw.Event.CREATED, e=>{
        const layer = e.layer;
        layer.customProperties = { tipo:'outro', cor:layer.options.color };
        drawnItems.addLayer(layer);

        if(layer instanceof L.Circle || layer instanceof L.CircleMarker){
            layer.on('click', event=>{
                layerSelecionada = layer;
                document.getElementById('acessorio-tipo').value = layer.customProperties.tipo;
                document.getElementById('acessorio-cor').value = layer.customProperties.cor;
                mostrarMenuPopup(event.originalEvent);
            });
        }
    });

    // Bot玫es do popup
    document.querySelector('.close-btn').addEventListener('click', fecharMenu);

    document.getElementById('apply-accessory').addEventListener('click', ()=>{
        if(layerSelecionada){
            const tipo = document.getElementById('acessorio-tipo').value;
            const cor  = document.getElementById('acessorio-cor').value;

            layerSelecionada.setStyle({color:cor});
            layerSelecionada.customProperties = { tipo, cor };

            const latlng = layerSelecionada.getLatLng ? layerSelecionada.getLatLng() : null;

            // ID 煤nico
            const id = L.Util.stamp(layerSelecionada);
            const obj = { id, tipo, cor, posicao: latlng };

            const idx = acessorios.findIndex(a => a.id === id);
            if(idx === -1){
                acessorios.push(obj);
            } else {
                acessorios[idx] = obj;
            }

            console.log("Lista atual de acess贸rios:", acessorios);
        }
        fecharMenu();
    });

    document.getElementById('delete-accessory').addEventListener('click', ()=>{
        if(layerSelecionada){
            const id = L.Util.stamp(layerSelecionada);
            acessorios = acessorios.filter(a => a.id !== id);
            drawnItems.removeLayer(layerSelecionada);
            layerSelecionada=null;
            console.log("Lista atual de acess贸rios:", acessorios);
        }
        fecharMenu();
    });

    map.on('dblclick', fecharMenu);
</script>
</body>
</html>
